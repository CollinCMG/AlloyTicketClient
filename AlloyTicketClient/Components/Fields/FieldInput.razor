@using AlloyTicketClient.Enums
@using AlloyTicketClient
@using Microsoft.AspNetCore.Components

@inject FormFieldService FormFieldService

@if (Field != null)
{
    <div class="field-block">
        <h4>
            @GetDisplayName(Field)
            @if (Field.Mandatory == true)
            {
                <span class="required" title="Required">*</span>
            }
        </h4>
        @if (Field.FieldType == FieldType.Input && !string.IsNullOrWhiteSpace(Field.LookupValues))
        {
            var options = ParseLookupValues(Field.LookupValues);
            <select class="form-control" value="@Value" @onchange="OnInputChangedHandler">
                <option value="">-- Select --</option>
                @foreach (var option in options)
                {
                    <option value="@option">@option</option>
                }
            </select>
        }
        else if (Field.FieldType == FieldType.Input)
        {
            <input type="text" class="form-control" value="@Value" @oninput="OnInputChangedHandler" />
        }
        else if (Field.FieldType == FieldType.Checkbox)
        {
            <input type="checkbox" class="form-check-input" checked="@(Value == "true" || Value == "True")" @onchange="OnCheckboxChangedHandler" />
        }
        else if (Field.FieldType == FieldType.Textarea)
        {
            <textarea class="form-control" value="@Value" @oninput="OnInputChangedHandler"></textarea>
        }
        else if (Field.FieldType == FieldType.Dropdown && !string.IsNullOrWhiteSpace(Field.TableName) && !string.IsNullOrWhiteSpace(Field.DisplayFields))
        {
            if (Options == null)
            {
                <span>Loading...</span>
            }
            else
            {
                <select class="form-control" value="@Value" @onchange="OnInputChangedHandler">
                    <option value="">-- Select --</option>
                    @foreach (var option in Options)
                    {
                        <option value="@option">@option</option>
                    }
                </select>
            }
        }
        else if (Field.FieldType == FieldType.Dropdown && Options != null)
        {
            <select class="form-control" value="@Value" @onchange="OnInputChangedHandler">
                <option value="">-- Select --</option>
                @foreach (var option in Options)
                {
                    <option value="@option">@option</option>
                }
            </select>
        }
        else if (Field.FieldType == FieldType.Dropdown || (Field.Field_Name?.Equals("Requester_Id", StringComparison.OrdinalIgnoreCase) ?? false))
        {
            <select class="form-control" value="@Value" @onchange="OnInputChangedHandler">
                <option value="">-- Select --</option>
                <!-- TODO: Populate with actual Requester options -->
            </select>
        }
        else if (Field.Field_Name?.Equals("Due_date", StringComparison.OrdinalIgnoreCase) ?? false)
        {
            <input type="date" class="form-control" value="@Value" @oninput="OnInputChangedHandler" />
        }
        else
        {
            <input type="text" class="form-control" value="@Value" @oninput="OnInputChangedHandler" />
        }
    </div>
}

@code {
    [Parameter] public FormFieldDto? Field { get; set; }
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> OnValueChanged { get; set; }

    private List<string>? Options;

    private async Task OnInputChangedHandler(ChangeEventArgs e)
    {
        await OnValueChanged.InvokeAsync(e.Value?.ToString());
    }

    private async Task OnCheckboxChangedHandler(ChangeEventArgs e)
    {
        var isChecked = e.Value is bool b ? b : (e.Value?.ToString() == "true" || e.Value?.ToString() == "True");
        await OnValueChanged.InvokeAsync(isChecked.ToString());
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDropdownOptions();
    }

    private async Task LoadDropdownOptions()
    {
        if (Field?.FieldType == FieldType.Dropdown && !string.IsNullOrWhiteSpace(Field.TableName) && !string.IsNullOrWhiteSpace(Field.DisplayFields))
        {
            Options = await FormFieldService.GetDropdownOptionsAsync(Field);
            StateHasChanged();
        }
        else
        {
            Options = null;
        }
    }

    private string GetDisplayName(FormFieldDto field)
    {
        // Always use Field_Label as the display name if present, otherwise fallback to Field_Name
        return string.IsNullOrWhiteSpace(field.Field_Label) ? field.Field_Name ?? string.Empty : field.Field_Label;
    }

    private IEnumerable<string> ParseLookupValues(string lookupValues)
    {
        // If the value contains a comma and a quote, extract the quoted part
        if (lookupValues.Contains('"'))
        {
            var quoteStart = lookupValues.IndexOf('"');
            var quoteEnd = lookupValues.LastIndexOf('"');
            if (quoteStart >= 0 && quoteEnd > quoteStart)
            {
                var quoted = lookupValues.Substring(quoteStart + 1, quoteEnd - quoteStart - 1);
                return quoted.Split(',', System.StringSplitOptions.RemoveEmptyEntries | System.StringSplitOptions.TrimEntries)
                    .Select(x => x.Replace("\"", string.Empty));
            }
        }
        // Otherwise, treat as a simple CSV
        return lookupValues.Split(',', System.StringSplitOptions.RemoveEmptyEntries | System.StringSplitOptions.TrimEntries)
            .Select(x => x.Replace("\"", string.Empty));
    }
}

@* Slide-over panel for employee actions (page-based) *@
@inject FormFieldService FormFieldService
@inject IJSRuntime JSRuntime
@using AlloyTicketClient.Components.Fields
@using AlloyTicketClient.Models
@using AlloyTicketClient.Enums

@if (Show)
{
    <div class="slide-over-overlay" @onclick="OnClose">
        <div class="slide-over-panel" @onclick:stopPropagation>
            <div class="slide-over-header">
                <h2>@Title</h2>
                <button class="slide-over-close" @onclick="OnClose">&times;</button>
            </div>
            <div class="slide-over-content">
                @if (isLoading)
                {
                    <p>Loading...</p>
                }
                else if (pages != null && pages.Count > 0)
                {
                    var p = pages[currentPageIndex];
                    <div class="form-page">
                        <h3>@p.PageName</h3>
                        @foreach (var item in p.Items)
                        {
                            if (item is FieldInputDto fieldInput)
                            {
                                var fieldKey = fieldInput.FieldName;
                                if (IsSupportedFieldInput(fieldInput))
                                {
                                    <FieldInput @key="fieldInput.FieldName"
                                               Field="@(MapToFormFieldDto(fieldInput))"
                                               Value="@(fieldValues.ContainsKey(fieldKey) ? fieldValues[fieldKey]?.ToString() : null)"
                                               OnValueChanged="@(val => OnFieldValueChanged(val, fieldKey))" />
                                }
                                else if (fieldInput.FieldName?.Equals("Due_date", StringComparison.OrdinalIgnoreCase) == true)
                                {
                                    <div class="field-block">
                                        <h4>@(string.IsNullOrWhiteSpace(fieldInput.FieldLabel) ? fieldInput.FieldName : fieldInput.FieldLabel)</h4>
                                        <input type="date" class="form-control"
                                               value="@(fieldValues.ContainsKey(fieldKey) ? fieldValues[fieldKey]?.ToString() : string.Empty)"
                                               @onchange="e => SetFieldValue(fieldKey, e.Value?.ToString())" />
                                    </div>
                                }
                                else if (fieldInput.FieldName?.Equals("Requester_Id", StringComparison.OrdinalIgnoreCase) == true)
                                {
                                    <div class="field-block">
                                        <h4>@(string.IsNullOrWhiteSpace(fieldInput.FieldLabel) ? fieldInput.FieldName : fieldInput.FieldLabel)</h4>
                                        <select class="form-control"
                                                value="@(fieldValues.ContainsKey(fieldKey) ? fieldValues[fieldKey]?.ToString() : string.Empty)"
                                                @onchange="e => SetFieldValue(fieldKey, e.Value?.ToString())">
                                            <option value="">-- Select --</option>
                                        </select>
                                    </div>
                                }
                                else
                                {
                                    <div class="field-block">
                                        <h4>@(string.IsNullOrWhiteSpace(fieldInput.FieldLabel) ? fieldInput.FieldName : fieldInput.FieldLabel)</h4>
                                        <input class="form-control" placeholder="Enter value..."
                                               value="@(fieldValues.ContainsKey(fieldKey) ? fieldValues[fieldKey]?.ToString() : string.Empty)"
                                               @onchange="e => SetFieldValue(fieldKey, e.Value?.ToString())" />
                                    </div>
                                }
                            }
                            else if (item is FieldTextDto fieldText)
                            {
                                <div class="field-text">@GetTextValue(fieldText.ElementDefinition)</div>
                            }
                            else if (item is AttachmentInputDto attachment)
                            {
                                // Use a unique key for the attachment field
                                var attachmentKey = $"attachment_{currentPageIndex}_{p.Items.IndexOf(item)}";
                                <InputFile class="form-control" OnChange="e => OnAttachmentChanged(e, attachmentKey)" />
                                @if (fieldValues.ContainsKey(attachmentKey))
                                {
                                    <div class="mt-1 text-success">File selected: @(((IBrowserFile)fieldValues[attachmentKey]).Name)</div>
                               }
                            }
                        }
                    </div>
                }
                else
                {
                    <p>No fields found for this form.</p>
                }
            </div>
            <div class="slide-over-footer" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                <button class="btn btn-secondary" @onclick="GoBack" disabled="@IsFirstPage" style="min-width: 100px;">Back</button>
                <div style="margin-left: auto;">
                    @if (!IsLastPage)
                    {
                        <button class="btn btn-primary" @onclick="GoNext" style="min-width: 100px;">Next</button>
                    }
                    else
                    {
                        <button class="btn btn-success" @onclick="SubmitForm" style="min-width: 100px;">Submit</button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? FormId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private bool isLoading = false;
    private List<PageDto>? pages;
    private int currentPageIndex = 0;
    private bool IsFirstPage => currentPageIndex == 0;
    private bool IsLastPage => pages == null || currentPageIndex == pages.Count - 1;
    private Dictionary<string, object?> fieldValues = new();
    private Guid? lastLoadedFormId = null;

    protected override async Task OnParametersSetAsync()
    {
        if (Show && Guid.TryParse(FormId, out var formId))
        {
            // Only reload if FormId changes or Show is toggled
            if (lastLoadedFormId != formId || pages == null)
            {
                isLoading = true;
                pages = null;
                currentPageIndex = 0;
                pages = await FormFieldService.GetFormPagesAsync(formId);
                lastLoadedFormId = formId;
                isLoading = false;
                StateHasChanged();
            }
        }
        else if (!Show)
        {
            pages = null;
            isLoading = false;
            currentPageIndex = 0;
            lastLoadedFormId = null;
        }
    }

    private void GoBack()
    {
        if (currentPageIndex > 0)
            currentPageIndex--;
    }

    private void GoNext()
    {
        if (pages != null && currentPageIndex < pages.Count - 1)
            currentPageIndex++;
    }

    private async Task SubmitForm()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(fieldValues);
        await JSRuntime.InvokeVoidAsync("alert", json);
        // TODO: send json to API or handle as needed
        Console.WriteLine(json);
    }

    // Helper to map FieldInputDto to FormFieldDto for FieldInput component
    private FormFieldDto MapToFormFieldDto(FieldInputDto input)
    {
        return new FormFieldDto
        {
            Field_Num = input.Field_Num,
            Field_Label = input.FieldLabel,
            Field_Name = input.FieldName,
            ID = input.DefinitionID ?? Guid.Empty,
            Virtual = input.Virtual,
            Mandatory = input.Mandatory,
            Read_Only = input.Read_Only,
            LookupValues = input.Lookup_Values,
            TableName = input.Table_Name,
            LookupID = input.Lookup_ID,
            Filter = input.Filter,
            FieldType = input.FieldType,
            DisplayFields = input.DisplayFields
        };
    }

    private bool IsSupportedFieldInput(FieldInputDto input)
    {
        // Use FieldType to determine if this input is supported by FieldInput.razor
        // Supported: not null and not FieldType.Null
        return input.FieldType != null && input.FieldType != FieldType.Null;
    }

    private string GetTextValue(string? elementDefinition)
    {
        if (string.IsNullOrWhiteSpace(elementDefinition))
            return string.Empty;

        try
        {
            var doc = System.Xml.Linq.XDocument.Parse(elementDefinition);
            var item = doc.Descendants("ITEM")
                          .FirstOrDefault(e => (string?)e.Attribute("Name") == "Text");
            return item?.Attribute("Value")?.Value ?? string.Empty;
        }
        catch
        {
            // Fallback: strip tags if not valid XML
            return System.Text.RegularExpressions.Regex.Replace(elementDefinition, "<.*?>", string.Empty).Trim();
        }
    }

    private T? GetFieldValue<T>(string key)
    {
        if (fieldValues.TryGetValue(key, out var value) && value is T t)
            return t;
        return default;
    }

    private void SetFieldValue<T>(string key, T value)
    {
        fieldValues[key] = value;
    }

    private string GetOrSetFieldValue(string key)
    {
        return fieldValues.TryGetValue(key, out var value) ? value?.ToString() ?? string.Empty : string.Empty;
    }
    private void GetOrSetFieldValue(string key, string value)
    {
        fieldValues[key] = value;
    }

    private Task OnFieldValueChanged(string? value, string fieldKey)
    {
        fieldValues[fieldKey] = value;
        return Task.CompletedTask;
    }

    private async Task OnAttachmentChanged(InputFileChangeEventArgs e, string key)
    {
        if (e.FileCount > 0)
        {
            // Store the first file (can be extended for multiple files)
            var file = e.File;
            fieldValues[key] = file;
        }
        else
        {
            fieldValues.Remove(key);
        }
    }
}
